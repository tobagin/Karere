app-id: io.github.tobagin.Karere
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: karere

# Add extensions for media and web browser support
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '23.08'
    add-ld-path: .

finish-args:
  # Network access for WhatsApp Web
  - --share=network
  # Access to display for GUI
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Audio/video for WhatsApp calls (future feature)
  - --socket=pulseaudio
  # File access for downloads and media
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures
  - --filesystem=xdg-documents
  # Device access for notifications
  - --talk-name=org.freedesktop.Notifications
  # Session bus access
  - --socket=session-bus
  # Allow spawning subprocesses (for backend)
  - --allow=devel
  # Chromium needs these permissions
  - --device=dri
  - --filesystem=xdg-run/pipewire-0:ro

modules:
  # Node.js runtime for the backend
  - name: nodejs
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin /app/lib /app/include /app/share
      - cp -r bin/* /app/bin/
      - cp -r lib/* /app/lib/
      - cp -r include/* /app/include/
      - cp -r share/* /app/share/
    sources:
      - type: archive
        url: https://nodejs.org/dist/v22.16.0/node-v22.16.0-linux-arm64.tar.xz
        sha256: eab80cb88f8fda1e65f5e8d0420c9809bdb320b03fd34976ab7161b6e703b910
        strip-components: 1
        only-arches:
          - aarch64
      - type: archive
        url: https://nodejs.org/dist/v22.16.0/node-v22.16.0-linux-x64.tar.xz
        sha256: f4cb75bb036f0d0eddf6b79d9596df1aaab9ddccd6a20bf489be5abe9467e84e
        strip-components: 1
        only-arches:
          - x86_64

  # Download and install Chromium for whatsapp-web.js backend
  - name: chromium
    buildsystem: simple
    build-commands:
      # Extract Chromium from the downloaded archive
      - mkdir -p /app/chromium
      - unzip -q chrome-linux.zip
      - cp -r chrome-linux/* /app/chromium/
      # Create wrapper script for Chromium
      - mkdir -p /app/bin
      - |
        cat > /app/bin/chromium-browser << 'EOF'
        #!/bin/bash
        # Set up Chromium environment for Flatpak sandbox
        export CHROME_WRAPPER=/app/bin/chromium-browser
        export CHROME_DESKTOP=karere-chromium.desktop

        # Chromium arguments for sandboxed environment
        CHROMIUM_FLAGS=(
          --no-sandbox
          --disable-setuid-sandbox
          --disable-dev-shm-usage
          --disable-gpu-sandbox
          --disable-software-rasterizer
          --disable-background-timer-throttling
          --disable-backgrounding-occluded-windows
          --disable-renderer-backgrounding
          --disable-features=TranslateUI,VizDisplayCompositor
          --disable-ipc-flooding-protection
          --no-first-run
          --disable-default-apps
          --disable-extensions
          --disable-sync
          --disable-translate
          --disable-background-networking
          --disable-background-timer-throttling
          --disable-client-side-phishing-detection
          --disable-component-update
          --disable-default-apps
          --disable-domain-reliability
          --disable-features=AudioServiceOutOfProcess,VizDisplayCompositor
          --disable-hang-monitor
          --disable-ipc-flooding-protection
          --disable-popup-blocking
          --disable-prompt-on-repost
          --disable-renderer-backgrounding
          --disable-sync
          --disable-translate
          --disable-windows10-custom-titlebar
          --metrics-recording-only
          --no-first-run
          --no-default-browser-check
          --no-pings
          --password-store=basic
          --use-mock-keychain
          --user-data-dir="$XDG_DATA_HOME/karere/chromium"
        )

        # Create user data directory
        mkdir -p "$XDG_DATA_HOME/karere/chromium"

        # Execute Chromium with our flags
        exec /app/chromium/chrome "${CHROMIUM_FLAGS[@]}" "$@"
        EOF
      - chmod +x /app/bin/chromium-browser
      # Create symlinks for compatibility
      - ln -sf chromium-browser /app/bin/chrome
      - ln -sf chromium-browser /app/bin/google-chrome
    sources:
      - type: archive
        url: https://storage.googleapis.com/chromium-browser-snapshots/Linux_x64/1477121/chrome-linux.zip
        sha256: 1b3593019d0f48882af91bc686643a23e8f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
        strip-components: 1
        only-arches:
          - x86_64
      - type: archive
        url: https://storage.googleapis.com/chromium-browser-snapshots/Linux_ARM64/1477121/chrome-linux.zip
        sha256: 2c4694029e1f58992bf02bc797754b34f9f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3
        strip-components: 1
        only-arches:
          - aarch64

  # Python dependencies for the frontend
  - name: python-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} pygobject
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/P/PyGObject/PyGObject-3.48.2.tar.gz
        sha256: 0794ba6f7a2b8f1d8b9b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b

  # Main Karere application
  - name: karere
    buildsystem: meson
    config-opts:
      - -Dflatpak=true
    build-commands:
      # Install backend dependencies
      - cd backend && npm ci --production --no-optional
      # Build frontend
      - meson setup builddir --prefix=/app
      - meson compile -C builddir
      - meson install -C builddir
      # Install backend to app directory
      - mkdir -p /app/share/karere
      - cp -r backend /app/share/karere/
      - cp -r frontend /app/share/karere/
      # Create launcher script that handles Flatpak environment
      - |
        cat > /app/bin/karere << 'EOF'
        #!/bin/bash

        # Set up environment for Flatpak
        export PATH="/app/bin:$PATH"
        export NODE_PATH="/app/share/karere/backend/node_modules"
        export KARERE_BACKEND_PATH="/app/share/karere/backend"
        export PYTHONPATH="/app/share/karere:$PYTHONPATH"

        # Set up data directory in user space
        export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
        export KARERE_DATA_DIR="$XDG_DATA_HOME/karere"
        mkdir -p "$KARERE_DATA_DIR"

        # Change to backend directory for proper relative paths
        cd /app/share/karere/backend

        # Launch the application
        exec python3 -m frontend.karere.main "$@"
        EOF
      - chmod +x /app/bin/karere
    sources:
      - type: dir
        path: .
        skip:
          - .git
          - builddir*
          - .flatpak-builder
          - backend/node_modules
          - backend/data
          - "*.db"
          - "*.log"
