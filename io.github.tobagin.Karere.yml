app-id: io.github.tobagin.Karere
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: karere

# Add extensions for media and web browser support
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '23.08'
    add-ld-path: .

finish-args:
  # Network access for WhatsApp Web API (Baileys backend)
  - --share=network
  # Access to display for GUI
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Audio/video for WhatsApp calls (future feature)
  - --socket=pulseaudio
  # File access for downloads and media
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures
  - --filesystem=xdg-documents
  # Device access for notifications
  - --talk-name=org.freedesktop.Notifications
  # Session bus access
  - --socket=session-bus
  # Allow spawning subprocesses (for Baileys backend)
  - --allow=devel

modules:
  # Blueprint compiler for UI files
  - name: blueprint-compiler
    buildsystem: meson
    sources:
      - type: git
        url: https://gitlab.gnome.org/jwestman/blueprint-compiler.git
        tag: v0.16.0

  # Python dependencies for the frontend
  - name: python3-websocket-client
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "websocket-client" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/5a/84/44687a29792a70e111c5c477230a72c4b957d88d16141199bf9acb7537a3/websocket_client-1.8.0-py3-none-any.whl
        sha256: 17b44cc997f5c498e809b22cdf2d9c7a9e71c02c8cc2b6c56e7c2d1239bfa526

  # Download karere-backend executable
  - name: karere-backend
    buildsystem: simple
    build-commands:
      - mkdir -p /app/bin
      - cp karere-backend /app/bin/
      - chmod +x /app/bin/karere-backend
    sources:
      - type: file
        url: https://github.com/tobagin/KarereBackend/releases/download/v0.2.2/karere-backend-linux-x64
        sha256: 380d522e3ddd651596f166a430c484283bd82525a4168713714bd3e77d697d9d
        dest-filename: karere-backend
        only-arches:
          - x86_64
      - type: file
        url: https://github.com/tobagin/KarereBackend/releases/download/v0.2.2/karere-backend-linux-arm64
        sha256: 3a4a7034c1246c17f07326d1ac4223927cca439772d129d300cb8a5c3e2930b7
        dest-filename: karere-backend
        only-arches:
          - aarch64



  # Main Karere application (frontend only)
  - name: karere
    buildsystem: simple
    build-commands:
      # Build frontend using meson
      - meson setup build --prefix=/app
      - meson compile -C build
      - meson install -C build
      # Install src to app directory
      - mkdir -p /app/share/karere
      - cp -r src /app/share/karere/
      # Install PNG icons in all standard sizes
      - mkdir -p /app/share/icons/hicolor/{16x16,22x22,24x24,32x32,48x48,64x64,128x128,256x256,512x512}/apps
      - cp src/data/icons/hicolor/16x16/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/16x16/apps/
      - cp src/data/icons/hicolor/22x22/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/22x22/apps/
      - cp src/data/icons/hicolor/24x24/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/24x24/apps/
      - cp src/data/icons/hicolor/32x32/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/32x32/apps/
      - cp src/data/icons/hicolor/48x48/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/48x48/apps/
      - cp src/data/icons/hicolor/64x64/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/64x64/apps/
      - cp src/data/icons/hicolor/128x128/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/128x128/apps/
      - cp src/data/icons/hicolor/256x256/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/256x256/apps/
      - cp src/data/icons/hicolor/512x512/apps/io.github.tobagin.Karere.png /app/share/icons/hicolor/512x512/apps/
      # Fix desktop file (meson installs it with the application ID name)
      - sed -i 's/@EXEC_NAME@/karere/g' /app/share/applications/io.github.tobagin.Karere.desktop
      # Fix metainfo file (meson installs it as .appdata.xml)
      - sed -i 's/@APP_ID@/io.github.tobagin.Karere/g' /app/share/metainfo/io.github.tobagin.Karere.appdata.xml
      # Rename to .metainfo.xml for proper AppStream compliance
      - mv /app/share/metainfo/io.github.tobagin.Karere.appdata.xml /app/share/metainfo/io.github.tobagin.Karere.metainfo.xml
      # Create launcher script that handles Flatpak environment
      - |
        cat > /app/bin/karere << 'EOF'
        #!/bin/bash

        # Set up environment for Flatpak
        export PATH="/app/bin:$PATH"
        export PYTHONPATH="/app/share/karere:$PYTHONPATH"

        # Set up data directory in user space
        export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
        export KARERE_DATA_DIR="$XDG_DATA_HOME/karere"
        mkdir -p "$KARERE_DATA_DIR"

        # Set backend executable path for the frontend
        export KARERE_BACKEND_EXECUTABLE="/app/bin/karere-backend"

        # Launch Karere with compiled Baileys backend
        echo "ğŸš€ Starting Karere (Flatpak edition)"
        echo "ğŸ“± Using compiled Baileys backend - Standalone executable with no runtime dependencies"

        # Launch the application
        exec python3 -m src.karere.main "$@"
        EOF
      - chmod +x /app/bin/karere
    sources:
      - type: dir
        path: .
        skip:
          - .git
          - build/
          - .flatpak-builder
          - "*.db"
          - "*.log"
